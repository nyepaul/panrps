#!/bin/bash
# Bump version number for cache-busting during debugging

if [ $# -eq 0 ]; then
    echo "Usage: ./bin/bump-version <new_version> [release_notes]"
    echo "Example: ./bin/bump-version 3.10.0 'Add new feature X'"
    exit 1
fi

NEW_VERSION=$1
RELEASE_NOTES=${2:-"Bug fixes and improvements"}
RELEASE_DATE=$(date +%Y-%m-%d)

# Update __version__.py
cat > src/__version__.py <<EOF
"""RPS Version Information"""

__version__ = "$NEW_VERSION"
__release_date__ = "$RELEASE_DATE"
__release_notes__ = "$RELEASE_NOTES"
EOF

# Update index.html cache-busting parameter
sed -i "s|/js/main.js?v=.*\"|/js/main.js?v=$NEW_VERSION\"|g" src/static/index.html

# Update index.html fallback version display (the visible version in footer)
sed -i "s|<span id=\"app-version\">v[0-9]\+\.[0-9]\+\.[0-9]\+</span>|<span id=\"app-version\">v$NEW_VERSION</span>|g" src/static/index.html

# Update config.js VERSION constant (fallback for when API not loaded yet)
sed -i "s|VERSION: '[0-9]\+\.[0-9]\+\.[0-9]\+'|VERSION: '$NEW_VERSION'|g" src/static/js/config.js

# Update login.html version display
sed -i "s|font-size: 10px; color: #ccc; font-weight: 500;\">v[0-9]\+\.[0-9]\+\.[0-9]\+</div>|font-size: 10px; color: #ccc; font-weight: 500;\">v$NEW_VERSION</div>|g" src/static/login.html

echo "‚úÖ Version bumped to $NEW_VERSION"
echo "üìÖ Release date: $RELEASE_DATE"
echo "üìù Notes: $RELEASE_NOTES"
echo ""
echo "Modified files:"
echo "  - src/__version__.py"
echo "  - src/static/index.html"
echo "  - src/static/js/config.js"
echo "  - src/static/login.html"
echo ""
echo "Don't forget to commit and deploy:"
echo "  git add src/__version__.py src/static/index.html src/static/js/config.js src/static/login.html"
echo "  git commit -m 'chore: bump version to $NEW_VERSION'"
echo "  git push"
echo "  sudo ./bin/deploy"
