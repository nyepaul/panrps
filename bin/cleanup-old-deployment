#!/bin/bash
# Cleanup old deployment files
# This removes old panrps references that were replaced with rps

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Cleaning up old deployment files ===${NC}"
echo ""

# Check if running as root or with sudo
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: This script must be run as root or with sudo${NC}"
    echo "Usage: sudo ./bin/cleanup-old-deployment"
    exit 1
fi

# Stop and disable old panrps service if it exists
if systemctl is-active --quiet panrps 2>/dev/null; then
    echo -e "${YELLOW}Stopping panrps service...${NC}"
    systemctl stop panrps
fi

if systemctl is-enabled --quiet panrps 2>/dev/null; then
    echo -e "${YELLOW}Disabling panrps service...${NC}"
    systemctl disable panrps
fi

# Remove old systemd service file
if [ -f /etc/systemd/system/panrps.service ]; then
    echo -e "${YELLOW}Removing /etc/systemd/system/panrps.service${NC}"
    rm -f /etc/systemd/system/panrps.service
fi

# Disable old Apache site
if [ -L /etc/apache2/sites-enabled/panrps.pan2.app.conf ]; then
    echo -e "${YELLOW}Disabling panrps.pan2.app Apache site...${NC}"
    a2dissite panrps.pan2.app.conf 2>/dev/null || true
fi

# Remove old Apache config
if [ -f /etc/apache2/sites-available/panrps.pan2.app.conf ]; then
    echo -e "${YELLOW}Removing /etc/apache2/sites-available/panrps.pan2.app.conf${NC}"
    rm -f /etc/apache2/sites-available/panrps.pan2.app.conf
fi

# Remove old deployment directory if it exists
if [ -d /var/www/panrps.pan2.app ]; then
    echo -e "${YELLOW}Found old deployment at /var/www/panrps.pan2.app${NC}"
    read -p "Do you want to remove /var/www/panrps.pan2.app? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Removing /var/www/panrps.pan2.app${NC}"
        rm -rf /var/www/panrps.pan2.app
    else
        echo -e "${YELLOW}Skipping removal of /var/www/panrps.pan2.app${NC}"
    fi
fi

# Reload systemd
echo -e "${YELLOW}Reloading systemd daemon...${NC}"
systemctl daemon-reload

# Reload Apache
echo -e "${YELLOW}Reloading Apache...${NC}"
systemctl reload apache2 2>/dev/null || systemctl restart apache2

echo ""
echo -e "${GREEN}=== Cleanup complete! ===${NC}"
echo ""
echo "Old deployment files have been removed."
echo "The rps deployment should now be the only active configuration."
echo ""
echo "Verify with:"
echo "  sudo systemctl status rps"
echo "  sudo apache2ctl -S"
