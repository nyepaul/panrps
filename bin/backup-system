#!/bin/bash
###############################################################################
# RPS System-Only Backup Script
#
# Backs up only system configuration and code
#
# Usage:
#   ./bin/backup-system [--keep N]
#
# Author: pan
# Date: 2026-01-20
###############################################################################

set -euo pipefail

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
BACKUP_DIR="${PROJECT_ROOT}/backups/system"
LOG_DIR="${PROJECT_ROOT}/logs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="rps_system_${TIMESTAMP}"
TEMP_DIR="/tmp/${BACKUP_NAME}"

# Default settings
KEEP_BACKUPS=7

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --keep) KEEP_BACKUPS="$2"; shift 2 ;;
        *) shift ;;
    esac
done

log() {
    local level=$1
    shift
    local message="$*"
    local timestamp=$(date +"%Y-%m-%d %H:%M:%S")

    mkdir -p "${LOG_DIR}"
    echo "[${timestamp}] [${level}] ${message}" >> "${LOG_DIR}/backup.log"

    case $level in
        INFO) echo -e "${BLUE}[INFO]${NC} ${message}" ;;
        SUCCESS) echo -e "${GREEN}[SUCCESS]${NC} ${message}" ;;
        WARNING) echo -e "${YELLOW}[WARNING]${NC} ${message}" ;;
        ERROR) echo -e "${RED}[ERROR]${NC} ${message}" ;;
    esac
}

error_exit() {
    log ERROR "$1"
    [[ -d "${TEMP_DIR}" ]] && rm -rf "${TEMP_DIR}"
    exit 1
}

trap 'error_exit "System backup failed at line $LINENO"' ERR

main() {
    log INFO "Starting RPS system-only backup: ${BACKUP_NAME}"

    mkdir -p "${BACKUP_DIR}"
    mkdir -p "${TEMP_DIR}/config"
    mkdir -p "${TEMP_DIR}/systemd"
    mkdir -p "${TEMP_DIR}/bin"
    mkdir -p "${TEMP_DIR}/logs"

    # Backup configuration
    log INFO "Backing up configuration files..."
    [[ -f "${PROJECT_ROOT}/.env" ]] && cp "${PROJECT_ROOT}/.env" "${TEMP_DIR}/config/" || true
    [[ -f "${PROJECT_ROOT}/.env.production" ]] && cp "${PROJECT_ROOT}/.env.production" "${TEMP_DIR}/config/" || true
    [[ -f "${PROJECT_ROOT}/alembic.ini" ]] && cp "${PROJECT_ROOT}/alembic.ini" "${TEMP_DIR}/config/" || true
    [[ -f "${PROJECT_ROOT}/.backup_config" ]] && cp "${PROJECT_ROOT}/.backup_config" "${TEMP_DIR}/config/" || true

    # Backup version and documentation
    [[ -f "${PROJECT_ROOT}/src/__version__.py" ]] && cp "${PROJECT_ROOT}/src/__version__.py" "${TEMP_DIR}/config/" || true
    for doc in CLAUDE.md README.md DEPLOYMENT.md; do
        [[ -f "${PROJECT_ROOT}/${doc}" ]] && cp "${PROJECT_ROOT}/${doc}" "${TEMP_DIR}/config/" || true
    done

    # Backup systemd files
    log INFO "Backing up systemd configuration..."
    if [[ -d "${PROJECT_ROOT}/systemd" ]]; then
        cp -r "${PROJECT_ROOT}/systemd/"* "${TEMP_DIR}/systemd/" 2>/dev/null || true
    fi

    # Backup utility scripts
    log INFO "Backing up management scripts..."
    if [[ -d "${PROJECT_ROOT}/bin" ]]; then
        cp "${PROJECT_ROOT}/bin/"* "${TEMP_DIR}/bin/" 2>/dev/null || true
    fi

    # Backup recent logs
    log INFO "Backing up recent logs..."
    if [[ -d "${PROJECT_ROOT}/logs" ]]; then
        find "${PROJECT_ROOT}/logs" -type f -mtime -7 -exec cp {} "${TEMP_DIR}/logs/" \; 2>/dev/null || true
    fi

    # Create metadata
    cat > "${TEMP_DIR}/backup_metadata.txt" << EOF
Backup Type: System Only
Backup Name: ${BACKUP_NAME}
Timestamp: $(date)
Hostname: $(hostname)
User: $(whoami)
RPS Version: $(python3 -c "import json; print(json.load(open('${PROJECT_ROOT}/src/static/version.json'))['version'])" 2>/dev/null || echo "unknown")
Configuration Files: $(find "${TEMP_DIR}/config" -type f | wc -l)
Scripts: $(find "${TEMP_DIR}/bin" -type f | wc -l)
EOF

    # Create archive
    log INFO "Creating compressed archive..."
    cd "${BACKUP_DIR}"
    tar -czf "${BACKUP_NAME}.tar.gz" -C /tmp "${BACKUP_NAME}"

    # Verify archive
    if tar -tzf "${BACKUP_NAME}.tar.gz" > /dev/null 2>&1; then
        log SUCCESS "Archive verified"
    else
        error_exit "Archive verification failed"
    fi

    local backup_size=$(du -h "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" | cut -f1)
    log SUCCESS "System backup created: ${BACKUP_NAME}.tar.gz (${backup_size})"

    # Cleanup
    rm -rf "${TEMP_DIR}"

    # Rotate old backups
    log INFO "Rotating old backups (keeping last ${KEEP_BACKUPS})..."
    cd "${BACKUP_DIR}"
    ls -t rps_system_*.tar.gz 2>/dev/null | tail -n +$((KEEP_BACKUPS + 1)) | while read old_backup; do
        log INFO "Removing old backup: ${old_backup}"
        rm -f "${old_backup}"
    done

    local backup_count=$(ls -1 rps_system_*.tar.gz 2>/dev/null | wc -l)
    log INFO "Total system backups: ${backup_count}"

    echo ""
    log SUCCESS "=== System Backup Complete ==="
    log INFO "Backup file: ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
    log INFO "Size: ${backup_size}"
    echo ""
}

main
exit 0
